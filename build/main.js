define("app/graph",["d3","jquery"],function(e,t){function r(e){return e.size>15?32:e.size>10?24:e.size>5?20:16}function i(e){var t=Math.min(e.source.size,e.target.size);return t>15?220:t>10?160:t>5?120:100}var n=function(n,r){var s={distance:200,charge:-100},o=this;this.options=t.extend(s,r);var u=t(window),a=u.width(),f=u.height();this.svg=e.select(n).append("svg"),this.nodes=[],this.links=[],this.link=null,this.node=null,this.force=e.layout.force().nodes(this.nodes).links(this.links).distance(this.options.distance).linkDistance(i).charge(this.options.charge).size([a,f]),this.force.on("tick",function(){o.link.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),o.node.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}),u.on("resize",function(){var e=u.width(),t=u.height();o.svg.attr("width",e-20).attr("height",t-20),o.force.size([e-20,t-20])})};return n.prototype.add=function(e,n,r,i){r=r||0,i=t.extend({},i);var s={name:e,image:n,size:r,o:i,__forceSize:r>0};return this.nodes.push(s),s},n.prototype.linkNodes=function(e,t){if(!e||!t)throw new Error("Cannot link empty nodes");return this.isLinkExists(e,t)?this:(this.links.push({source:e,target:t}),[e,t].forEach(function(e){e.__forceSize||e.size++}),this)},n.prototype.find=function(e){for(var t=0,n=this.nodes.length;t<n;t++)if(this.nodes[t].name===e)return this.nodes[t];return null},n.prototype.isLinkExists=function(e,t){for(var n=0,r=this.links.length;n<r;n++)if(this.links[n].source===e&&this.links[n].target===t)return!0;return!1},n.prototype.update=function(){var e=this;e.link=this.svg.selectAll(".link").data(e.links,function(e){return e.source.name+"-"+e.target.name}),e.link.enter().insert("svg:line",".node").attr("class","link").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),e.link.exit().remove(),e.node=e.svg.selectAll(".node").data(e.nodes,function(e){return e.name}),e.node.selectAll("image").transition().attr("x",function(e){return-r(e)/2}).attr("y",function(e){return-r(e)/2}).attr("width",r).attr("height",r);var t=e.node.enter().append("g").attr("class","node").call(e.force.drag);t.append("image").attr("xlink:href",function(e){return e.image}).attr("x",function(e){return-r(e)/2}).attr("y",function(e){return-r(e)/2}).attr("width",r).attr("height",r),t.append("text").attr("dx",12).attr("dy",".35em").text(function(e){return e.name}),t.append("title").text(function(e){return e.name}),e.node.exit().remove(),e.force.start()},n.prototype.clear=function(){this.nodes=[],this.links=[],this.link=null,this.node=null,this.force.nodes(this.nodes).links(this.links)},n}),define("app/user",[],function(){var e=function(e,t,n){this.nickname=e,this.url=t||"/users/"+e+"/",this.avatar=n||null,this.friends=[],this.invitedBy=null,this.isDeleted=!1,this.__storage=!1};return e.prototype.addFriend=function(e){this.friends.push(e)},e.prototype.markAsDeleted=function(){this.isDeleted=!0,this.avatar="/i/avatars/stub-user-middle.gif"},e}),define("app/storage",[],function(){return{save:function(e,t,n){return n=n||"",window.localStorage.setItem(n+e,JSON.stringify(t)),this},load:function(e,t){t=t||"";var n=window.localStorage.getItem(t+e);return n!==null?JSON.parse(n):null},clear:function(){return window.localStorage.clear(),this},remove:function(e,t){return t=t||"",window.localStorage.removeItem(t+e),this}}}),define("app/app",["jquery","app/graph","app/user","app/storage"],function(e,t,n,r){var i=function(t){var n={sampleRate:650};this.options=e.extend(n,t),this.queue=[],this.graph=null,this.isStoped=!1,this.isStarted=!1};return i.prototype.init=function(e,n){var r=this;r.graph=new t(e.get(0),{}),r.reset(n)},i.prototype.reset=function(e){var t=this;t.queue=[],t.graph.clear(),t.graph.update(),t.addUFO();for(var n=0,r=e.length;n<r;n++)t.addToQueue(e[n],"low"),t.addToGraph(e[n]);t.graph.update()},i.prototype.addUFO=function(){var e=this,t=new n("НЛО","/");t.avatar="/favicon.ico",e.addToGraph(t,40)},i.prototype.tick=function(){var e=this;if(e.isStoped)return;var t=e.queue.shift();if(t===undefined){setTimeout(function(){e.tick()},e.options.sampleRate);return}console.log("Request for "+t.nickname),e.requestUser(t).then(function(t){var n=e.findNode(t)||e.addToGraph(t),r=e.findNode(t.invitedBy);r!==null?e.graph.linkNodes(n,r).update():e.addToQueue(t.invitedBy,"high"),t.friends.forEach(function(t){var r=e.findNode(t);r!==null?e.graph.linkNodes(r,n).update():e.addToQueue(t,"low")});var i=t.__storage?150:e.options.sampleRate;setTimeout(function(){e.tick()},i)})},i.prototype.requestUser=function(t){var i=r.load(t.nickname,"user."),s=e.Deferred();return i!==null?(i.__storage=!0,s.resolve(i),console.log("loaded from cache")):e.get(t.url,function(i){var o=e(i);if(e("h1",o).text()=="Доступ закрыт")t.markAsDeleted();else{if(t.invitedBy===null){var u=e("#invited-by",o),a="",f="";u.length===0?a="НЛО":(a=u.text().trim()||null,f=u.attr("href")||null),t.invitedBy=new n(a,f)}t.avatar=e(".user_header .avatar img",o).attr("src");var l=e('#invited_data_items li a[rel="friend"]',o);t.friends=l.map(function(){var r=e(this),i=r.text().trim(),s=r.attr("href"),o=new n(i,s);return o.invitedBy=new n(t.nickname,t.url),o}).get()}r.save(t.nickname,t,"user."),console.log("saved to cache"),s.resolve(t)}),s.promise()},i.prototype.addToQueue=function(e,t){t=t||"low",t==="high"?this.queue.unshift(e):this.queue.push(e)},i.prototype.addToGraph=function(e,t,n){return this.graph.add(e.nickname,e.avatar,t,n)},i.prototype.linkUsers=function(e,t){var n=this.findNode(e),r=this.findNode(t);n&&r&&this.graph.linkNodes(n,r)},i.prototype.refresh=function(){return this.graph.update()},i.prototype.findNode=function(e){return this.graph.find(e.nickname)},i.prototype.start=function(){this.isStarted=!0,this.tick()},i.prototype.resume=function(){this.isStoped=!1,this.tick()},i.prototype.stop=function(){this.isStoped=!0},i}),require(["app/app","app/user","jquery"],function(e,t,n){function f(){var e=n('<div id="controls"></div>').appendTo(i);n('<button id="btn-start">start</button>').appendTo(e).on("click",function(){return u.start(),!1}),n('<button id="btn-stop">stop</button>').appendTo(e).on("click",function(){return u.stop(),!1}),n('<button id="btn-continue">resume</button>').appendTo(e).on("click",function(){return u.resume(),!1});var t=n('<select id="btn-init-qty"></select>').appendTo(e).on("change",function(){var e=n(this),t=+e.val(),r=+e.data("current");u.isStarted===!1||t<r?u.reset(o.slice(0,t)):o.slice(r,t).forEach(function(e){u.addToQueue(e,"high")}),e.data("current",t)});for(var s=1;s<=100;s++)n("<option></option>").text(s).val(s).appendTo(t);t.find("[value="+r+"]").attr("selected","selected").data("current",r)}var r=3,i=n(document.body);if(document.URL.indexOf("habrahabr.ru/users")===-1){alert("Необходимо находиться на странице http://habrahabr.ru/users/ для построения графа");return}var s=n("#peoples",i),o=[];s.find(".user").each(function(){var e=n(this),r=e.find(".username a"),i=e.find(".avatar img"),s=new t(r.text().trim(),r.attr("href"),i.attr("src"));o.push(s)}),i.html("").show();var u=new e;f();var a=n('<div id="canvas"></div>').appendTo(i);u.init(a,o.slice(0,r))}),define("app/init",function(){}),require.config({paths:{jquery:"//yandex.st/jquery/2.0.3/jquery.min",d3:"//cdnjs.cloudflare.com/ajax/libs/d3/3.3.9/d3.min",app:"app"},shim:{d3:{exports:"d3"}}}),require(["app/init"]),define("main",function(){});